<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Data Automation & Reporting Tool</title>
    <style>
      :root {
        color-scheme: light;
      }
      body {
        font-family: "Georgia", serif;
        background: #f6f2ea;
        color: #1f1a14;
        margin: 0;
        padding: 40px 20px;
      }
      .card {
        max-width: 880px;
        margin: 0 auto;
        background: #fffaf2;
        border: 1px solid #e2d5c3;
        border-radius: 14px;
        padding: 28px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      }
      h1 {
        margin: 0 0 12px;
        font-size: 30px;
      }
      p {
        line-height: 1.6;
        margin: 0 0 12px;
      }
      .section {
        margin-top: 22px;
        padding-top: 16px;
        border-top: 1px dashed #d6c8b4;
      }
      .actions {
        margin-top: 16px;
      }
      a.button,
      button.button {
        display: inline-block;
        background: #1f1a14;
        color: #fffaf2;
        text-decoration: none;
        padding: 10px 16px;
        border-radius: 8px;
        font-weight: 600;
        border: none;
        cursor: pointer;
      }
      code,
      pre {
        background: #efe6d7;
        padding: 10px;
        border-radius: 8px;
        display: block;
        overflow-x: auto;
      }
      label {
        display: block;
        margin: 12px 0 6px;
        font-weight: 600;
      }
      textarea {
        width: 100%;
        min-height: 140px;
        border-radius: 8px;
        border: 1px solid #d6c8b4;
        padding: 10px;
        font-family: "Courier New", monospace;
      }
      .output {
        margin-top: 12px;
        white-space: pre-wrap;
      }
      .error {
        color: #8b1a1a;
        font-weight: 600;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Data Automation & Reporting Tool</h1>
      <p>
        This demo reads sales data, removes missing values, and generates a
        summary report.
      </p>
      <p>
        Default report endpoint: <code>/api/report</code>
      </p>
      <div class="actions">
        <a class="button" href="/api/report">Open Default Report (CSV)</a>
      </div>

      <div class="section">
        <h2>Upload Your Own CSV</h2>
        <p>Required columns: <strong>date, sales, profit</strong></p>
        <pre>date,sales,profit
2025-01-01,1200,300
2025-01-02,1500,420</pre>

        <form id="upload-form">
          <label for="csv-file">Select CSV file</label>
          <input id="csv-file" type="file" accept=".csv" />

          <label for="csv-text">Or paste CSV text</label>
          <textarea id="csv-text" placeholder="date,sales,profit"></textarea>

          <div class="actions">
            <button class="button" type="submit">Generate Report</button>
          </div>
        </form>

        <div class="section">
          <strong>Report Output</strong>
          <div id="message" class="output"></div>
          <pre id="output" class="output"></pre>
          <div class="actions" id="download-area" style="display: none;">
            <a id="download-link" class="button" download="summary_report.csv">Download Report</a>
          </div>
        </div>
      </div>
    </div>

    <script>
      const form = document.getElementById("upload-form");
      const fileInput = document.getElementById("csv-file");
      const textInput = document.getElementById("csv-text");
      const output = document.getElementById("output");
      const message = document.getElementById("message");
      const downloadArea = document.getElementById("download-area");
      const downloadLink = document.getElementById("download-link");

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        message.textContent = "";
        message.className = "output";
        output.textContent = "";
        downloadArea.style.display = "none";

        let csvText = "";
        if (fileInput.files.length > 0) {
          csvText = await fileInput.files[0].text();
        } else if (textInput.value.trim()) {
          csvText = textInput.value.trim();
        }

        if (!csvText) {
          message.textContent = "Please select a CSV file or paste CSV text.";
          message.className = "output error";
          return;
        }

        try {
          const response = await fetch("/api/report_upload", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ csv: csvText })
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            message.textContent = errorData.error || "Failed to generate report.";
            message.className = "output error";
            return;
          }

          const reportCsv = await response.text();
          output.textContent = reportCsv;

          const blob = new Blob([reportCsv], { type: "text/csv" });
          const url = URL.createObjectURL(blob);
          downloadLink.href = url;
          downloadArea.style.display = "block";
        } catch (error) {
          message.textContent = "Network error. Please try again.";
          message.className = "output error";
        }
      });
    </script>
  </body>
</html>
